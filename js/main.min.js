"use strict";

$(function () {
  var assetsPath, copyLinkLabel;

  if (typeof window.assetsPath === 'undefined') {
    assetsPath = '';
  } else {
    assetsPath = window.assetsPath;
  }

  if (typeof window.copyLinkLabel === 'undefined') {
    copyLinkLabel = 'Копировать ссылку';
  } else {
    copyLinkLabel = window.copyLinkLabel;
  }

  if (navigator.userAgent.indexOf('Windows') > 0) {
    $('.scene').addClass('scene_win');
  }

  $(window).scroll(function () {
    if ($(this).scrollTop() > 0) {
      $('.top').addClass('top_less');
    } else {
      $('.top').removeClass('top_less');
    }
  });
  var topNav = $('.navigation'),
      topNavLink = topNav.find('.navigation__link_dropdown');
  topNavLink.on('click', function (e) {
    e.preventDefault();
    $('.navigation__link').removeClass('navigation__link_active');
    $(this).addClass('navigation__link_active');
    var id = $(this).attr('href'),
        thisParent = $(e.target).closest('.top'),
        dropdownMenu = thisParent.find($(id));
    $('.navigation-dropdown').not($(id)).removeClass('navigation-dropdown_show');
    dropdownMenu.toggleClass('navigation-dropdown_show');

    if (dropdownMenu.hasClass('navigation-dropdown_show')) {
      $('.top').addClass('top_open');
    } else {
      $('.top').removeClass('top_open');
      $(this).removeClass('navigation__link_active');
    }
  });
  $('.top__overlay').on('click', function (e) {
    $('.top').removeClass('top_open');
    $('.navigation__link').removeClass('navigation__link_active');
    $('.navigation-dropdown').removeClass('navigation-dropdown_show');
    e.preventDefault();
  });
  $('.mobile-menu').on('click', function (e) {
    $('body').toggleClass('burger-opened');
    e.preventDefault();
  });
  $('.burger-menu__close').on('click', function (e) {
    $('body').toggleClass('burger-opened');
    e.preventDefault();
  });

  var copyToClipboard = function copyToClipboard(str) {
    var el = document.createElement('textarea');
    el.value = str;
    el.setAttribute('readonly', '');
    el.style.position = 'absolute';
    el.style.left = '-9999px';
    document.body.appendChild(el);
    var selected = document.getSelection().rangeCount > 0 ? document.getSelection().getRangeAt(0) : false;
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);

    if (selected) {
      document.getSelection().removeAllRanges();
      document.getSelection().addRange(selected);
    }
  };

  var shareBlock = $('.share-block__yandex').eq(0);

  if (shareBlock.length) {
    Ya.share2(shareBlock[0], {
      content: {
        url: shareBlock.data('url'),
        title: shareBlock.data('title'),
        description: shareBlock.data('description'),
        image: shareBlock.data('image')
      },
      theme: {
        services: 'vkontakte,facebook,twitter,telegram',
        counter: false,
        lang: 'ru',
        limit: 5,
        size: 'm',
        bare: true,
        direction: 'horizontal'
      },
      hooks: {
        onready: function onready() {
          $(this._domNode).find('li').each(function (i, el) {
            var regex = /ya-share2__item_service_([a-z]+)\s?/m;
            var service = $(el).attr('class').match(regex);

            if (service.length > 0 && service[1]) {
              $(el).find('a').html($(".social-svg-".concat(service[1])).clone());
            }
          });
          $(this._domNode).find('ul').append('<li class="ya-share2__item ya-share2__item_service_link">\
                            <a href="#" class="copy-link"><span>' + copyLinkLabel + '</span></a>\
                        </li>');
          $(this._domNode).on('click', '.ya-share2__item_service_link a', function (e) {
            e.preventDefault();
            copyToClipboard(shareBlock.data('url'));
            $(e.currentTarget).addClass('copied');
            setTimeout(function () {
              $(e.currentTarget).removeClass('copied');
            }, 1000);
          });
        }
      }
    });
  }

  if ($('.input-field__info').length > 0) {
    $('.input-field').on('mouseover', '.input-field__info', function (e) {
      var block = $(e.delegateTarget);
      block.find('.input-field__info-card').fadeIn();
    });
    $('.input-field').on('mouseout', '.input-field__info', function (e) {
      var block = $(e.delegateTarget);
      block.find('.input-field__info-card').fadeOut();
    });
  }

  if ($('.question-mark').length > 0) {
    $('.course-set__content-item').on('mouseover', '.question-mark', function (e) {
      var block = $(e.delegateTarget);
      block.find('.question-explain').fadeIn();
    });
    $('.course-set__content-item').on('mouseout', '.question-mark', function (e) {
      var block = $(e.delegateTarget);
      block.find('.question-explain').fadeOut();
    });
  }

  if ($('.go-to-calc').length > 0) {
    $('.go-to-calc').on('click', function () {
      $('html, body').animate({
        'scrollTop': $('.course-calc').closest('.course__block').offset().top - 80
      }, 300);
      return false;
    });
  }

  if ($('.swiper-container-days').length > 0) {
    new Swiper('.swiper-container-days', {
      freeMode: true,
      freeModeSticky: true,
      width: 29,
      spaceBetween: 15 // on: {
      //     init: () => {
      //         console.log($('.course-day_mode_curr').is(':visible'));
      //     }
      // }

    });
  }

  $('.cards').on('click', '.cards__load-more', function (e) {
    var ajaxCall = $.ajax({
      url: 'cards.html',
      dataType: 'html'
    });
    ajaxCall.done(function (response) {
      $('.cards__wrapper_more_container').append(response);
      var cardsLeft = ajaxCall.getResponseHeader('left');

      if (!cardsLeft) {
        $('.cards .cards__load-more').parent().hide();
        $('.cards').off('click', '.cards__load-more');
      }
    });
    ajaxCall.fail(function (err) {
      alert(err.toString());
    });
    e.preventDefault();
  });
  $('.input-field').each(function (i, block) {
    var isWebkit = /webkit/.test(navigator.userAgent);

    if ($(block).find('.input-field__input').val() !== '' || isWebkit && $(block).is(':-webkit-autofill')) {
      $(block).addClass('input-field_focus_yes');
    }
  });
  $('.input-field').on('focus', '.input-field__input', function (e) {
    var wrapper = $(e.delegateTarget);
    wrapper.addClass('input-field_focus_yes');
  });
  $('.input-field').on('animationend', '.input-field__input', function (e) {
    var wrapper = $(e.delegateTarget);

    if (e.originalEvent.animationName === 'onAutoFillStart') {
      wrapper.addClass('input-field_focus_yes');
    }
  });
  $('.input-field').on('change blur', '.input-field__input', function (e) {
    var wrapper = $(e.delegateTarget);
    var input = $(e.target);

    if (input.val() === '') {
      wrapper.removeClass('input-field_focus_yes');
    }
  });

  if ($('.input-field-select2').length) {
    $('.input-field-select2 select').select2({
      data: [{
        id: 0,
        text: 'enhancement'
      }, {
        id: 1,
        text: 'bug'
      }, {
        id: 2,
        text: 'duplicate'
      }, {
        id: 3,
        text: 'invalid'
      }, {
        id: 4,
        text: 'wontfix'
      }, {
        id: 0,
        text: 'enhancement'
      }, {
        id: 1,
        text: 'bug'
      }, {
        id: 2,
        text: 'duplicate'
      }, {
        id: 3,
        text: 'invalid'
      }, {
        id: 4,
        text: 'wontfix'
      }] // ajax: {
      //     type: 'POST',
      //     url: 'https://ru.siberianhealth.com/ru/controller/ajax/',
      //     dataType: 'json',
      //     xhrFields: {
      //         withCredentials: true
      //     },
      //     headers: {
      //         'X-Requested-With': 'XMLHttpRequest'
      //     },
      //     data: function (params) {
      //         console.log(params);
      //         return {
      //             q: params.term,
      //             _type: params._type,
      //             _controller: 'Universiade/get_shipping_cities',
      //             _url: 'https://ru.siberianhealth.com/ru/cyberbuild/'
      //         }
      //     },
      //     processResults: function (data) {
      //         console.log(data);
      //         return {
      //             results: data
      //         };
      //     }
      // }

    });
  }

  if ($('.course-set').length > 0) {
    $('.course-set').on('click', '.course-set__info-switcher', function (e) {
      var block = $(e.delegateTarget);
      var info = block.find('.course-set__info');

      if (info.hasClass('course-set__info_expanded_yes')) {
        info.removeClass('course-set__info_expanded_yes');
        info.find('ul').slideUp();
      } else {
        info.addClass('course-set__info_expanded_yes');
        info.find('ul').slideDown();
      }

      return false;
    });
    $('.course-set__info ul').slideUp();
  }

  if ($('.radio-button').length > 0) {
    $('.radio-button').on('click', '.radio-button__button', function (e) {
      var target = $(e.target);
      var block = $(e.delegateTarget);

      if (!target.hasClass('radio-button__button_selected_yes')) {
        block.find('.radio-button__button_selected_yes').removeClass('radio-button__button_selected_yes');
        target.addClass('radio-button__button_selected_yes');
      }

      return false;
    });
  }

  if ($('.course-calc').length > 0) {
    (function () {
      var calc = $('.course-calc');
      var defaultValues = {
        ages: '',
        height: '',
        weight: '',
        gender: 'm',
        activity: 1
      };
      var activities = {
        1: 1.375,
        2: 1.55,
        3: 1.725,
        4: 1.9
      };
      var extra = {
        m: 5,
        f: -161
      };
      var calculated = false;

      function setDefault() {
        Object.keys(defaultValues).forEach(function (key) {
          var value = defaultValues[key];
          var input = calc.find(".course-calc__field[data-name=".concat(key, "]"));

          if (!input) {
            return;
          }

          input.data('value', value).trigger('update', value);
        });
      }

      function validateForm() {
        var valid = true;
        Object.keys(defaultValues).forEach(function (key) {
          var input = calc.find(".course-calc__field[data-name=".concat(key, "]"));

          if (!input) {
            valid = false;
          }

          if (input.data('value') === '' || input.hasClass('invalid')) {
            valid = false;
          }
        });

        if (!valid) {
          $('.course-calc__calc').prop('disabled', 'disabled').attr('disabled', 'disabled');
        } else {
          $('.course-calc__calc').removeProp('disabled').removeAttr('disabled');
        }
      }

      function resetForm() {
        $('.course-calc__result').slideUp(function () {
          $('.course-calc__result--value').text('0');
        });
        $('.course-calc__sell').slideUp();
      }

      function recalcForm() {
        var values = Object.assign({}, defaultValues);
        Object.keys(defaultValues).forEach(function (key) {
          var input = calc.find(".course-calc__field[data-name=".concat(key, "]"));

          if (!input) {
            return;
          }

          values[key] = input.data('value');
        });
        var value = (values.weight * 10 + values.height * 6.25 - values.ages * 5 + extra[values.gender]) * activities[values.activity];
        var result = 0;

        if (value <= 1599) {
          result = 1300;
        }

        if (value >= 1600 && value <= 2000) {
          result = 1700;
        }

        if (value > 2000) {
          result = 2100;
        }

        $('.course-set__amount').val(result).trigger('change');
        $('.course-calc__result--value').text(result);
        $('.course-calc__result').slideDown();
        $('.course-calc__sell').slideDown();
      }

      $('.course-calc__field').on('update', function (e, data) {
        var target = $(e.target);
        target.data('value', data);

        if (target.prop('tagName') === 'INPUT') {
          target.val(data);
        }

        if (target.prop('tagName') === 'DIV') {
          target.find('.radio-button__button_selected_yes').removeClass('radio-button__button_selected_yes');
          target.find(".radio-button__button[data-value=".concat(data, "]")).addClass('radio-button__button_selected_yes');
          target.find('.radio-button__selection').text(target.find('.radio-button__button_selected_yes').text());
        }
      });
      $('.radio-button').on('touchstart', '.radio-button__selection', function (e) {
        var target = $(e.target);
        var block = $(e.delegateTarget);
        block.find('.radio-button__buttons').show();
        return false;
      });
      $('.radio-button').on('click', '.radio-button__button', function (e) {
        resetForm();
        var target = $(e.target);
        var block = $(e.delegateTarget);
        var desc = target.data('desc');
        block.trigger('update', target.data('value'));

        if (desc) {
          $('.course-calc__desc').text(desc);
        }

        if (block.find('.radio-button__selection').is(':visible')) {
          block.find('.radio-button__buttons').hide();
        }

        return false;
      });
      $('.radio-button').on('mouseover', '.radio-button__button', function (e) {
        var target = $(e.target);
        var desc = target.data('desc');

        if (desc) {
          $('.course-calc__desc').text(desc);
        }
      });
      $('.radio-button').on('mouseout', '.radio-button__button', function (e) {
        var block = $(e.delegateTarget);
        var desc = block.find('.radio-button__button_selected_yes').data('desc');

        if (desc) {
          $('.course-calc__desc').text(desc);
        }
      });
      $('.course-calc').on('keyup change', '.course-calc__input', function (e) {
        resetForm();
        var target = $(e.target);
        target.removeClass('invalid');
        var invalid = false;
        var val = target.val();

        if (val !== '') {
          val = parseInt(val);
        }

        var min = parseInt(target.attr('min')) || 10;
        var max = parseInt(target.attr('max')) || 300;

        if (val < min) {
          invalid = true;
        }

        if (val > max) {
          invalid = true;
        }

        target.val(val).data('value', val);

        if (invalid) {
          target.addClass('invalid');
        }

        validateForm();
        return false;
      });
      $('.course-calc').on('submit', 'form', function (e) {
        recalcForm();
        e.preventDefault();
      });
      setDefault();
    })();
  }

  if ($('.course-set__amount').length > 0) {
    $('.course-set__amount').select2({
      minimumResultsForSearch: Infinity,
      dropdownParent: $('.course-sets')
    });
  }

  if ($('.course__block_foldable_yes').length > 0) {
    $('.course__block_foldable_yes').on('click', '.course__block--fold-title .button', function (e) {
      var block = $(e.delegateTarget);

      if (block.hasClass('course__block_folded_yes')) {
        block.removeClass('course__block_folded_yes');
        block.find('.course__block--fold-content').slideDown();
      } else {
        block.addClass('course__block_folded_yes');
        block.find('.course__block--fold-content').slideUp();
      }

      return false;
    });
    $('.course__block--fold-content').slideUp();
  }

  if ($('.simple-form__notice-resend').length > 0 && $('.simple-form__notice-resend-link').length > 0) {
    var time = 10;
    var interval = setInterval(function () {
      time = time - 1;
      $('.timeleft').text(time);

      if (time === 0) {
        clearInterval(interval);
        $('.simple-form__notice-resend').hide();
        $('.simple-form__notice-resend-link').show();
      }
    }, 1000);
  }

  if ($('.article__list').length > 0) {
    $('.article__list').find('.article-content-box').each(function (index, el) {
      if ($(window).outerWidth() < 768) {
        $(el).addClass('article-content-box_mode_close').find('.article-content-box__image, .article-content-box__content').slideUp();
      } else {
        $(el).removeClass('article-content-box_mode_close').find('.article-content-box__image, .article-content-box__content').slideDown();
      }
    });
    $('.article-content-box').on('click', '.article-content-box__title', function (e) {
      var block = $(e.delegateTarget);

      if ($(window).outerWidth() < 768) {
        if (block.hasClass('article-content-box_mode_close')) {
          block.removeClass('article-content-box_mode_close');
          block.find('.article-content-box__image, .article-content-box__content').slideDown();
        } else {
          block.addClass('article-content-box_mode_close');
          block.find('.article-content-box__image, .article-content-box__content').slideUp();
        }
      } else {
        block.removeClass('article-content-box_mode_close');
        block.find('.article-content-box__image, .article-content-box__content').slideDown();
      }

      return false;
    });
  }

  $('.marathons__slider').slick({
    infinite: false,
    slidesToShow: 3,
    useTransform: false,
    arrows: false,
    dots: true,
    speed: 175,
    swipeToSlide: true,
    touchThreshold: 250,
    rows: 1,
    responsive: [{
      breakpoint: 1024,
      settings: {
        slidesToShow: 3
      }
    }, {
      breakpoint: 768,
      settings: {
        slidesToShow: 2
      }
    }, {
      breakpoint: 475,
      settings: {
        slidesToShow: 1
      }
    }]
  });

  if ($('.js--goToSets').length) {
    $('.js--goToSets').on('click', function (e) {
      e.preventDefault;
      $('html, body').animate({
        'scrollTop': $('.course-sets').offset().top - 130
      }, 300);
      return false;
    });
  }

  $('.recipes__slider').slick({
    infinite: false,
    slidesToShow: 5,
    useTransform: false,
    speed: 175,
    swipeToSlide: true,
    touchThreshold: 250,
    rows: 1,
    prevArrow: $('.recipes__controls__button--prev'),
    nextArrow: $('.recipes__controls__button--next'),
    responsive: [{
      breakpoint: 1280,
      settings: {
        slidesToShow: 4
      }
    }, {
      breakpoint: 1024,
      settings: {
        slidesToShow: 3
      }
    }, {
      breakpoint: 960,
      settings: {
        slidesToShow: 3
      }
    }, {
      breakpoint: 768,
      settings: {
        slidesToShow: 2.5
      }
    }, {
      breakpoint: 640,
      settings: {
        slidesToShow: 2
      }
    }, {
      breakpoint: 480,
      settings: {
        slidesToShow: 1.5
      }
    }, {
      breakpoint: 320,
      settings: {
        slidesToShow: 1
      }
    }]
  });
  $('.reviews-slider').on('init reInit afterChange', function (event, slick, currentSlide, nextSlide) {
    var i = (currentSlide ? currentSlide : 0) + 1;
    $('.reviews__controls__fraction').text(i + ' / ' + slick.slideCount);
  });
  $('.reviews-slider').slick({
    prevArrow: $('.reviews__controls__button--prev'),
    nextArrow: $('.reviews__controls__button--next')
  });
  $('.course-days__slider').slick({
    accessibility: false,
    mobileFirst: true,
    infinite: false,
    arrows: false,
    variableWidth: true,
    useTransform: false,
    swipeToSlide: true,
    touchThreshold: 50,
    responsive: [{
      breakpoint: 1020,
      settings: 'unslick'
    }]
  });
  $('.input-field_type_tel .country-select').select2({
    dropdownParent: '.scene',
    minimumResultsForSearch: -1,
    width: 'element',
    dropdownAutoWidth: true,
    theme: 'country',
    templateSelection: function templateSelection(country) {
      var $image = $('<img class="country-select__flag" src="' + assetsPath + 'images/flags/1x1/' + country.id + '.svg">');
      return $image;
    },
    templateResult: function templateResult(country) {
      var $image = $('<img class="country-select__flag" src="' + assetsPath + 'images/flags/1x1/' + country.id + '.svg">');
      return $image;
    }
  });
  var $countrySelect = $('.input-field_type_tel .country-select');
  $countrySelect.on('change', function () {
    var country = $(this).val(),
        $phoneInput = $('.input-field_type_tel .input-field__input'),
        phoneMask;
    phoneMask = lookUp[country];
    $phoneInput.mask(phoneMask, {
      autoclear: false
    });
    $phoneInput.on('blur', function () {
      if ($(this).val().length === 0) {
        $(this).parent().removeClass('input-field_focus_yes');
      }
    });
  });
  $countrySelect.trigger('change');
});